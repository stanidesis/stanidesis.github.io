<script type="text/javascript">
  /* Returns an array where index is the unique identifier, value is the name */
  var pullDataFromDropdown = function(selector) {
    var $dropdowns = $(selector);
    var array = new Array($dropdowns.length);
    $dropdowns.each(function() {
      array[parseInt($(this).attr('data-choice').match(/\d+/g))] = $(this).text();
    });
    return array;
  };

  /* Hides/reveals the button in the modal, assigns URL if present */
  var showHideModalButton = function($modal, id, url) {
    var $button = $modal.find(id);
    if (!url) {
      $button.hide();
      return;
    }
    $button.show().attr('href', url);
  };

  window.dependenciesReady = function() {
    /* Drop-down filter activate/deactivate */
    $('.dropdown button').on('click', function(e) {
      var $activeDropdown = $('.dropdown.is-active').first();
      if ($activeDropdown[0] && $(this)[0] != $activeDropdown.find('button').first()[0]) {
        $activeDropdown.removeClass('is-active');
      }
      $(this).parents('.dropdown').toggleClass('is-active');
      e.stopPropagation();
    });
    /* Click outside closes all dropdowns */
    $('html').on('click', function(e) {
      $('.dropdown.is-active').toggleClass('is-active');
    });

    /* Load all roles, clients, and topics into objects */
    window.allRoles = pullDataFromDropdown('#dropdown-roles a.dropdown-item');
    window.allClients = pullDataFromDropdown('#dropdown-clients a.dropdown-item');
    window.allTopics = pullDataFromDropdown('#dropdown-topics a.dropdown-item');

    /* Browji direct link */
    $('a.browji-link').click(function() {
      // TODO: correct this to the right work
      revealModalWith(window.allWorks[0]);
    });

    /* Let's get filters working */
    window.filteredRole = -1;
    window.filteredClient = -1;
    window.filteredTopic = -1;
    $('a.dropdown-item').click(function() {

    });

    /* Load all works */
    var $workEntries = $('.column.is-one-quarter');
    window.allWorks = new Array($workEntries.length);
    $workEntries.each(function() {
      var work = {};
      var $work = $(this);
      work.id = $work.attr('data-id');
      work.title = $work.attr('data-title');
      work.subtitle = $work.attr('data-subtitle');
      work.content = $work.attr('data-output');
      work.banner = $work.attr('data-banner');
      work.urlPlay = $work.attr('data-url-play');
      work.urlRead = $work.attr('data-url-read');
      work.urlVisit = $work.attr('data-url-visit');
      work.urlAndroidInstall = $work.attr('data-url-android-install');
      work.urliOSInstall = $work.attr('data-url-ios-install');
      work.urlChromeInstall = $work.attr('data-url-chrome-install');
      work.urlDownloadPDF = $work.attr('data-url-download-pdf');
      work.urlSource = $work.attr('data-url-source');
      window.allWorks[parseInt(work.id.match(/\d+/g))] = work;
    });

    $('.modal-background, .modal-close').click(function() {
      $(this).parent().toggleClass('is-active');
    });

    /* On Click for each work */
    $workEntries.click(function() {
      var work = window.allWorks[parseInt($(this).attr('data-id').match(/\d+/g))];
      revealModalWith(work);
    });

    var revealModalWith = function(work) {
      var $modal = $('.modal').first();
      $modal.find('figure > img').attr('src', work.banner);
      $modal.find('h1').first().text(work.title);
      $modal.find('h2').first().text(work.subtitle);
      $modal.find('.content').html(work.content);
      /* Handle buttons */
      showHideModalButton($modal, '#modal-button-play', work.urlPlay);
      showHideModalButton($modal, '#modal-button-read', work.urlRead);
      showHideModalButton($modal, '#modal-button-visit', work.urlVisit);
      showHideModalButton($modal, '#modal-button-install-android', work.urlAndroidInstall);
      showHideModalButton($modal, '#modal-button-install-ios', work.urliOSInstall);
      showHideModalButton($modal, '#modal-button-install-chrome', work.urlChromeInstall);
      showHideModalButton($modal, '#modal-button-download', work.urlDownloadPDF);
      showHideModalButton($modal, '#modal-button-source', work.urlSource);
      $modal.toggleClass('is-active');
    }

  }
</script>
